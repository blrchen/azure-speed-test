#!/usr/bin/env node

const { existsSync, readFileSync, writeFileSync } = require('node:fs')
const { resolve } = require('node:path')

const API_URL = 'https://azureiplookup-westus3.azurewebsites.net/api/serviceTagsByService'
const projectRoot = resolve(__dirname, '..')
const outputPath = resolve(
  projectRoot,
  'src/app/pages/information/azure-ip-ranges-by-service/service-ip-ranges.data.ts'
)

const indent = (level) => '  '.repeat(level)

const formatEntry = (entry) => {
  const rangesBlock = entry.ranges.map((range) => `${indent(3)}'${range}'`).join(',\n')

  return `${indent(1)}{\n${indent(2)}service: '${entry.service}',\n${indent(2)}ranges: [\n${rangesBlock}\n${indent(2)}]\n${indent(1)}}`
}

const buildFileContents = (entries) => {
  const headerComment = `// Auto-generated by scripts/generate-service-ip-ui-data.js on ${new Date().toISOString()}\n// Source: ${API_URL}\n`
  const interfaceDeclaration =
    'export interface ServiceIpRangeEntry {\n' +
    `${indent(1)}service: string\n` +
    `${indent(1)}ranges: string[]\n` +
    '}\n'

  const directoryBlock = `export const SERVICE_IP_RANGE_DIRECTORY: ServiceIpRangeEntry[] = [\n${entries
    .map(formatEntry)
    .join(',\n')}\n]\n`

  return `${headerComment}\n${interfaceDeclaration}\n${directoryBlock}`
}

const normalisePayload = (payload) => {
  if (!Array.isArray(payload)) {
    throw new Error('Unexpected payload structure received from API.')
  }

  return payload
    .filter(
      (item) =>
        item &&
        typeof item.SystemService === 'string' &&
        Array.isArray(item.ServiceTags) &&
        item.ServiceTags.length
    )
    .map((item) => {
      const ranges = Array.from(
        new Set(item.ServiceTags.map((value) => `${value}`.trim()).filter(Boolean))
      ).sort((a, b) => a.localeCompare(b))

      return {
        service: item.SystemService.trim(),
        ranges
      }
    })
    .filter((item) => item.ranges.length)
    .sort((a, b) => a.service.localeCompare(b.service))
}

const fetchServiceTags = async () => {
  const response = await fetch(API_URL, {
    headers: {
      'User-Agent': 'azure-speed-test/cli'
    }
  })

  if (!response.ok) {
    throw new Error(`Failed to fetch service tags (HTTP ${response.status})`)
  }

  return response.json()
}

const writeOutput = (contents) => {
  writeFileSync(outputPath, contents, { encoding: 'utf8' })
  console.log(`Service IP ranges updated (${outputPath})`)
}

const run = async () => {
  try {
    const payload = await fetchServiceTags()
    const entries = normalisePayload(payload)
    const fileContents = buildFileContents(entries)

    const existingContents = existsSync(outputPath)
      ? readFileSync(outputPath, { encoding: 'utf8' })
      : null

    if (existingContents === fileContents) {
      console.log('Service IP ranges are already up to date.')
      return
    }

    writeOutput(fileContents)
  } catch (error) {
    console.error('[service-ip-ranges] Unable to refresh data:', error.message)

    if (!existsSync(outputPath)) {
      process.exitCode = 1
      console.error(
        '[service-ip-ranges] No existing data file found; aborting to avoid empty dataset.'
      )
    } else {
      console.warn(
        '[service-ip-ranges] Continuing with existing data. Rerun the generator when network access is restored.'
      )
    }
  }
}

run()
