<article class="page-shell section-stack mx-auto max-w-5xl">
  <header class="page-header">
    <h1 class="page-title">Azure IP ranges by service</h1>
    <p class="page-lead">
      Discover IP ranges for Azure services to configure NSG rules, firewall allow-lists, and
      troubleshoot connectivity. Useful for allow-listing PaaS services like Databricks, SQL, or
      Storage in corporate firewalls.
    </p>
  </header>

  <section class="section-block" aria-labelledby="service-directory-heading">
    <h2 id="service-directory-heading" class="section-title">Service directory</h2>
    <p class="mb-3 text-sm text-text-muted">
      Browse Azure services and their associated IP ranges. Select a service to view its network
      prefixes. Service names with regional suffixes such as
      <code class="rounded border border-border-soft bg-surface-muted px-1.5 py-0.5 text-xs"
        >ActionGroup.AustraliaCentral</code
      >
      represent location-specific IP ranges. Looking for region-based data?
      <a class="link-primary" routerLink="/Information/AzureIpRangesByRegion">
        View Azure IP ranges by region</a
      >.
    </p>
    <div class="card overflow-hidden">
      <header class="card-header flex flex-wrap items-center justify-between gap-3">
        <div class="flex flex-wrap items-center gap-3">
          <span class="font-semibold">Browse services</span>
          <span
            id="service-count-hint"
            class="inline-flex items-center rounded-full bg-surface-muted px-3 py-1 text-xs font-semibold text-text-muted"
          >
            {{ filteredServiceCount() }} of {{ totalServiceCount() }}
          </span>
        </div>
        <span class="text-sm text-text-muted"> {{ totalRangeCount() }} total IP ranges </span>
      </header>
      <div class="card-body flex flex-col gap-4">
        <label class="sr-only" for="ip-service-search">Search services</label>
        <div class="relative w-full">
          <app-lucide-icon
            name="search"
            class="pointer-events-none absolute top-1/2 left-3 h-4 w-4 -translate-y-1/2 text-text-muted"
            aria-hidden="true"
          />
          <input
            id="ip-service-search"
            type="search"
            [value]="searchTerm()"
            (input)="onSearchInput($event)"
            placeholder="Search by service name..."
            autocomplete="off"
            aria-describedby="service-count-hint"
            class="form-control form-control-focus-ring w-full pr-10 pl-9 placeholder:text-text-placeholder"
          />
          @if (searchTerm()) {
            <button
              type="button"
              class="form-icon-clear h-7 w-7 rounded-full border-none bg-transparent text-text-subtle transition hover:bg-surface-muted focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:outline-none"
              (click)="clearSearch()"
              aria-label="Clear search"
            >
              <app-lucide-icon name="x" class="h-4 w-4" aria-hidden="true" />
            </button>
          }
        </div>

        @if (filteredServices().length === 0 && searchTerm()) {
          <div
            class="flex flex-col items-center gap-3 rounded-xl border-2 border-dashed border-border-contrast bg-surface-raised p-8 text-center text-sm text-text-muted"
            aria-live="polite"
          >
            <app-lucide-icon name="search-x" class="h-10 w-10 text-warning" aria-hidden="true" />
            <p class="text-base font-semibold text-text-strong">No services match your search</p>
            <p>Try a different keyword or reset the filter.</p>
            <button type="button" class="btn btn-secondary btn--sm" (click)="clearSearch()">
              Clear search
            </button>
          </div>
        } @else {
          <ul class="flex flex-col gap-3">
            @for (service of filteredServices(); track service.name) {
              <li class="flex flex-col gap-2">
                <button
                  type="button"
                  class="btn btn-outline btn--fluid w-full items-center justify-between gap-3 text-sm font-semibold"
                  (click)="selectService(service.name)"
                  [class]="
                    selectedServiceId() === service.name
                      ? 'border-brand bg-brand/10 text-brand-dark'
                      : 'border-border-soft bg-surface-raised text-text-strong'
                  "
                  [attr.aria-expanded]="selectedServiceId() === service.name"
                  [attr.aria-controls]="'service-panel-' + service.name"
                  [attr.aria-label]="service.name + ', ' + service.rangeCount + ' IP ranges'"
                >
                  <span class="flex flex-1 items-center gap-3 text-left">
                    <app-lucide-icon
                      [name]="
                        selectedServiceId() === service.name ? 'chevron-down' : 'chevron-right'
                      "
                      class="h-4 w-4 shrink-0 transition-transform"
                      aria-hidden="true"
                    />
                    <span class="break-words">{{ service.name }}</span>
                  </span>
                  <span class="badge badge-brand justify-center px-2" aria-hidden="true">
                    {{ service.rangeCount }}
                  </span>
                </button>

                @if (selectedServiceId() === service.name) {
                  <div
                    class="-mt-1 flex flex-col gap-3 rounded-t-lg rounded-b-2xl border border-t-0 border-brand/50 bg-brand/5 p-4 shadow-brand-sm"
                    aria-live="polite"
                    [id]="'service-panel-' + service.name"
                  >
                    <div class="text-sm font-semibold text-brand-dark">
                      Showing {{ service.rangeCount }} IP ranges for {{ service.name }}.
                    </div>
                    <div class="grid gap-2 sm:grid-cols-2 lg:grid-cols-3">
                      @for (range of service.ranges; track range) {
                        <a
                          class="inline-flex min-w-0 items-center rounded-xl px-3 py-2 text-xs font-semibold transition hover:shadow-md focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:outline-none"
                          [class]="
                            isGlobalRange(range)
                              ? 'bg-brand/10 text-brand-dark hover:bg-brand/20'
                              : 'bg-surface-raised text-brand hover:bg-brand/10'
                          "
                          [routerLink]="['/Information/AzureIpRanges', range]"
                          [state]="{ source: 'service' }"
                        >
                          @if (isGlobalRange(range)) {
                            <app-lucide-icon
                              name="globe"
                              class="mr-1.5 h-3 w-3 shrink-0"
                              aria-hidden="true"
                            />
                          }
                          <span class="break-all" [title]="range">{{ range }}</span>
                        </a>
                      }
                    </div>
                  </div>
                }
              </li>
            }
          </ul>
        }
      </div>
    </div>
  </section>
</article>
